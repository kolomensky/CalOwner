<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ï–¥–∏–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --accent: #06b6d4;
      --muted: #9ca3af;
      --text: #e5e7eb;
      --danger: #f43f5e;
      --success: #22c55e;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at 15% 20%, rgba(6, 182, 212, 0.12), transparent 25%),
        radial-gradient(circle at 80% 0%, rgba(244, 63, 94, 0.12), transparent 28%), var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    header {
      padding: 36px 24px 20px;
      max-width: 1200px;
      margin: 0 auto;
      text-align: center;
    }

    h1 {
      margin: 0 0 12px;
      font-size: 40px;
      letter-spacing: -0.02em;
    }

    p.lead {
      margin: 0 auto;
      max-width: 720px;
      color: var(--muted);
      line-height: 1.6;
      font-size: 17px;
    }

    nav.primary {
      width: min(1200px, 100%);
      padding: 0 24px 12px;
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin: 0 auto 6px;
    }

    nav.primary a {
      text-decoration: none;
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      color: var(--text);
      background: rgba(255, 255, 255, 0.04);
      font-weight: 600;
      letter-spacing: 0.01em;
      transition: border-color 0.15s ease, background 0.15s ease, transform 0.08s ease;
    }

    nav.primary a.active {
      border-color: rgba(6, 182, 212, 0.5);
      background: linear-gradient(120deg, rgba(6, 182, 212, 0.2), rgba(34, 197, 94, 0.15));
      transform: translateY(-1px);
    }

    main {
      width: min(1200px, 100%);
      margin: 0 auto;
      padding: 0 24px 32px;
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    .home-layout {
      display: grid;
      gap: 16px;
      grid-template-rows: auto 1fr;
      height: calc(100vh - 220px);
      max-height: 760px;
      overflow: hidden;
    }

    .home-layout .card {
      margin: 0;
    }

    body.home-view {
      overflow: hidden;
    }

    .home-week .week-wrapper {
      height: min(540px, calc(100vh - 360px));
    }

    .home-week .week {
      height: 100%;
      align-items: start;
    }

    .home-week .day {
      max-height: none;
      height: 100%;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
    }

    .card {
      background: linear-gradient(145deg, rgba(17, 24, 39, 0.94), rgba(15, 23, 42, 0.94));
      border: 1px solid rgba(255, 255, 255, 0.04);
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.35);
      border-radius: 18px;
      padding: 20px;
    }

    .card h2 {
      margin: 0 0 12px;
      font-size: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card h2 span.icon {
      font-size: 22px;
    }

    label {
      display: block;
      margin: 12px 0 6px;
      color: var(--muted);
      font-size: 14px;
    }

    input,
    select,
    textarea,
    button {
      width: 100%;
      padding: 11px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(255, 255, 255, 0.03);
      color: var(--text);
      font-size: 15px;
      transition: border-color 0.15s ease, transform 0.08s ease;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: 2px solid rgba(6, 182, 212, 0.35);
      border-color: var(--accent);
    }

    button {
      border: none;
      cursor: pointer;
      margin-top: 14px;
      font-weight: 600;
      letter-spacing: 0.01em;
      background: linear-gradient(120deg, #06b6d4, #22c55e);
      color: #0b0f1a;
      box-shadow: 0 10px 28px rgba(6, 182, 212, 0.25);
    }

    button.secondary {
      background: rgba(255, 255, 255, 0.06);
      color: var(--text);
      box-shadow: none;
    }

    button:active {
      transform: translateY(1px);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      background: rgba(255, 255, 255, 0.06);
      border-radius: 999px;
      font-size: 13px;
      color: var(--muted);
      margin-right: 8px;
      margin-bottom: 8px;
    }

    .pill button {
      border: none;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      padding: 0 2px;
      font-size: 16px;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: auto;
    }

    .pill button:hover {
      color: var(--danger);
    }

    .pill .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
    }

    .pill .count {
      color: var(--text);
      font-weight: 700;
    }

    .calendar-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .events {
      display: grid;
      gap: 12px;
      margin-top: 8px;
    }

    .event {
      padding: 14px;
      border-radius: 14px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.04);
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
    }

    .event .meta {
      color: var(--muted);
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .event .badge {
      padding: 4px 9px;
      border-radius: 999px;
      color: #0b0f1a;
      font-weight: 700;
      font-size: 12px;
    }

    .empty {
      padding: 14px;
      background: rgba(255, 255, 255, 0.04);
      border-radius: 12px;
      border: 1px dashed rgba(255, 255, 255, 0.12);
      color: var(--muted);
      text-align: center;
    }

    .toolbar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 6px;
    }

    .toolbar button {
      flex: 1;
      min-width: 180px;
    }

    @media (max-width: 640px) {
      header {
        padding-top: 44px;
      }

      h1 {
        font-size: 32px;
      }

      .event {
        grid-template-columns: 1fr;
      }
    }

    .week-wrapper {
      overflow-x: auto;
      padding-bottom: 6px;
    }

    .week {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(7, minmax(180px, 1fr));
      min-width: calc(7 * 180px);
    }

    .day {
      padding: 14px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      display: grid;
      gap: 10px;
      min-height: 180px;
      max-height: 360px;
      overflow-y: auto;
    }

    .day h3 {
      margin: 0;
      font-size: 15px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: space-between;
    }

    .day h3 .count {
      background: rgba(255, 255, 255, 0.06);
      border-radius: 999px;
      padding: 4px 8px;
      color: var(--text);
      font-size: 12px;
    }

    .day .event-item {
      background: rgba(255, 255, 255, 0.04);
      border-radius: 12px;
      padding: 10px;
      border: 1px solid rgba(255, 255, 255, 0.04);
      display: grid;
      gap: 6px;
    }

    .muted-note {
      color: var(--muted);
      font-size: 14px;
      margin: 4px 0 0;
    }

    .stack {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .file-hint {
      color: var(--muted);
      font-size: 13px;
      margin: 4px 0 0;
    }

    .status {
      font-size: 14px;
      color: var(--muted);
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <header>
    <p class="pill">
      <span class="dot" style="background:#22c55e"></span>
      <span class="count" id="calendarCount">0</span> –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π –æ–±—ä–µ–¥–∏–Ω–µ–Ω–æ
    </p>
    <h1>–ï–¥–∏–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</h1>
    <p class="lead">
      –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–∞–±–æ—á—É—é –Ω–µ–¥–µ–ª—é —Ü–µ–ª–∏–∫–æ–º. –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å—Å—ã–ª–æ–∫, –∏–º–ø–æ—Ä—Ç —Ñ–∞–π–ª–æ–≤,
      —Ä—É—á–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –∏ –≤—ã–≥—Ä—É–∑–∫–∞) –¥–æ—Å—Ç—É–ø–Ω—ã –≤ —Ä–∞–∑–¥–µ–ª–∞—Ö –Ω–∏–∂–µ.
    </p>
  </header>

  <nav class="primary">
    <a href="#" class="active" data-page-target="home">–ì–ª–∞–≤–Ω–∞—è</a>
    <a href="#" data-page-target="calendars">–ö–∞–ª–µ–Ω–¥–∞—Ä–∏</a>
    <a href="#" data-page-target="events">–°–æ–±—ã—Ç–∏—è</a>
    <a href="#" data-page-target="import">–ò–º–ø–æ—Ä—Ç</a>
    <a href="#" data-page-target="upcoming">–õ–µ–Ω—Ç–∞</a>
  </nav>

  <main>
    <section class="page active" data-page="home">
      <div class="home-layout">
        <article class="card">
          <h2><span class="icon">üéØ</span>–ì–ª–∞–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å</h2>
          <p class="lead" style="max-width: 880px; margin: 6px 0 14px;">
            –°–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π –∑–∞ —Ä–∞–±–æ—á—É—é –Ω–µ–¥–µ–ª—é –Ω–∞ –æ–¥–Ω–æ–º —ç–∫—Ä–∞–Ω–µ. –î–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π, —ç–∫—Å–ø–æ—Ä—Ç–∞ –∏–ª–∏ –∏–º–ø–æ—Ä—Ç–∞
            –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Ä–∞–∑–¥–µ–ª.
          </p>
          <div class="toolbar" style="margin-top:0;">
            <button class="secondary" data-page-target="calendars">–ö–∞–ª–µ–Ω–¥–∞—Ä–∏</button>
            <button class="secondary" data-page-target="events">–î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏—è</button>
            <button class="secondary" data-page-target="import">–ò–º–ø–æ—Ä—Ç</button>
            <button class="secondary" data-page-target="upcoming">–õ–µ–Ω—Ç–∞</button>
          </div>
        </article>
        <article class="card home-week">
          <h2><span class="icon">üóìÔ∏è</span>–†–∞–±–æ—á–∞—è –Ω–µ–¥–µ–ª—è</h2>
          <div class="week-wrapper">
            <div class="week" id="weekView"></div>
          </div>
        </article>
      </div>
    </section>

    <section class="page" data-page="calendars">
      <div class="grid">
        <article class="card">
          <h2><span class="icon">üìÖ</span>–ö–∞–ª–µ–Ω–¥–∞—Ä–∏</h2>
          <form id="calendarForm">
            <label for="calendarName">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
            <input id="calendarName" name="calendarName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –†–∞–±–æ—Ç–∞" required />

            <label for="calendarColor">–¶–≤–µ—Ç</label>
            <input id="calendarColor" name="calendarColor" type="color" value="#06b6d4" />

            <button type="submit">–î–æ–±–∞–≤–∏—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å</button>
          </form>

          <div class="calendar-list" id="calendarList"></div>
        </article>

        <article class="card">
          <h2><span class="icon">üåê</span>–ü–æ–¥–∫–ª—é—á–∏—Ç—å ICS-—Å—Å—ã–ª–∫—É</h2>
          <form id="remoteForm">
            <label for="remoteUrl">–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—å (ics)</label>
            <input id="remoteUrl" name="remoteUrl" type="url" placeholder="https://example.com/calendar.ics" required />

            <label for="remoteName">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
            <input id="remoteName" name="remoteName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è —ç—Ç–æ–≥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—è" />

            <label for="remoteColor">–¶–≤–µ—Ç</label>
            <input id="remoteColor" name="remoteColor" type="color" value="#22c55e" />

            <button type="submit">–ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å –ø–æ —Å—Å—ã–ª–∫–µ</button>
          </form>

          <div class="toolbar" style="margin-top:12px">
            <button class="secondary" id="refreshRemote">–û–±–Ω–æ–≤–∏—Ç—å –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã–µ</button>
          </div>

          <p class="empty" id="remoteStatus" style="margin-top:12px">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Å—Å—ã–ª–∫—É, —á—Ç–æ–±—ã –ø–æ–¥—Ç—è–Ω—É—Ç—å –≥–æ—Ç–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è.</p>
        </article>
      </div>
    </section>

    <section class="page" data-page="events">
      <div class="grid">
        <article class="card">
          <h2><span class="icon">üóÇÔ∏è</span>–°–æ–±—ã—Ç–∏—è</h2>
          <form id="eventForm">
            <label for="eventCalendar">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</label>
            <select id="eventCalendar" required></select>

            <label for="eventTitle">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</label>
            <input id="eventTitle" placeholder="–í—Å—Ç—Ä–µ—á–∞ —Å –∫–æ–º–∞–Ω–¥–æ–π" required />

            <label for="eventStart">–ù–∞—á–∞–ª–æ</label>
            <input id="eventStart" type="datetime-local" required />

            <label for="eventEnd">–û–∫–æ–Ω—á–∞–Ω–∏–µ</label>
            <input id="eventEnd" type="datetime-local" required />

            <label for="eventLocation">–ú–µ—Å—Ç–æ/—Å—Å—ã–ª–∫–∞</label>
            <input id="eventLocation" placeholder="Zoom, –æ—Ñ–∏—Å –∏–ª–∏ –∞–¥—Ä–µ—Å" />

            <button type="submit">–î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ</button>
          </form>
        </article>

        <article class="card">
          <h2><span class="icon">üì§</span>–≠–∫—Å–ø–æ—Ä—Ç –∏ –æ—á–∏—Å—Ç–∫–∞</h2>
          <div class="toolbar" style="margin-top:6px">
            <button id="exportBtn">–≠–∫—Å–ø–æ—Ä—Ç –≤ ICS</button>
            <button class="secondary" id="clearBtn">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
          </div>
          <p class="status">–í—ã–≥—Ä—É–∑–∫–∞ —Å–æ–∑–¥–∞—ë—Ç –æ–±—â–∏–π —Ñ–∞–π–ª ICS —Å–æ –≤—Å–µ–º–∏ —Å–æ–±—ã—Ç–∏—è–º–∏ –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π.</p>
        </article>
      </div>
    </section>

    <section class="page" data-page="import">
      <article class="card">
        <h2><span class="icon">üìÇ</span>–ò–º–ø–æ—Ä—Ç —Ñ–∞–π–ª–æ–≤</h2>
        <form id="fileForm" class="stack">
          <div>
            <label for="fileInput">–í—ã–±–µ—Ä–∏—Ç–µ .ics –∏–ª–∏ calendar.html</label>
            <input
              id="fileInput"
              name="fileInput"
              type="file"
              accept=".ics,.ical,.ifb,.icalendar,.html,text/calendar,text/html"
            />
            <p class="file-hint">ICS –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é. –î–ª—è HTML –ø—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å —Å–æ–±—ã—Ç–∏—è –∏–∑ —Ç–µ–∫—Å—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã.</p>
          </div>
          <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
            <div>
              <label for="fileCalendarName">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—è</label>
              <input id="fileCalendarName" name="fileCalendarName" placeholder="–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å" />
            </div>
            <div>
              <label for="fileCalendarColor">–¶–≤–µ—Ç</label>
              <input id="fileCalendarColor" name="fileCalendarColor" type="color" value="#a855f7" />
            </div>
          </div>
          <button type="submit">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </form>
        <p class="status" id="fileStatus">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è offline-—Ñ–∞–π–ª—ã ICS –∏ HTML.</p>
      </article>
    </section>

    <section class="page" data-page="upcoming">
      <article class="card">
        <h2><span class="icon">üß≠</span>–ë–ª–∏–∂–∞–π—à–∏–µ —Å–æ–±—ã—Ç–∏—è</h2>
        <div class="events" id="events"></div>
      </article>
    </section>
  </main>
  <script>
    const calendarForm = document.getElementById("calendarForm");
    const eventForm = document.getElementById("eventForm");
    const calendarList = document.getElementById("calendarList");
    const eventsEl = document.getElementById("events");
    const calendarCount = document.getElementById("calendarCount");
    const eventCalendar = document.getElementById("eventCalendar");
    const exportBtn = document.getElementById("exportBtn");
    const clearBtn = document.getElementById("clearBtn");
    const remoteForm = document.getElementById("remoteForm");
    const remoteStatus = document.getElementById("remoteStatus");
    const refreshRemote = document.getElementById("refreshRemote");
    const weekView = document.getElementById("weekView");
    const fileForm = document.getElementById("fileForm");
    const fileInput = document.getElementById("fileInput");
    const fileCalendarName = document.getElementById("fileCalendarName");
    const fileCalendarColor = document.getElementById("fileCalendarColor");
    const fileStatus = document.getElementById("fileStatus");
    const navLinks = document.querySelectorAll("[data-page-target]");
    const pages = document.querySelectorAll(".page");

    const AUTO_REFRESH_MS = 5 * 60 * 1000;

    const state = {
      calendars: [],
      events: [],
    };

    let dbPromise = null;

    function showPage(page) {
      pages.forEach((section) => {
        section.classList.toggle("active", section.dataset.page === page);
      });

      navLinks.forEach((link) => {
        const isActive = link.dataset.pageTarget === page;
        if (link.tagName === "A") {
          link.classList.toggle("active", isActive);
        }
      });

      document.body.classList.toggle("home-view", page === "home");
    }

    navLinks.forEach((link) => {
      link.addEventListener("click", (event) => {
        event.preventDefault();
        showPage(link.dataset.pageTarget);
      });
    });

    showPage("home");

    function openDB() {
      if (dbPromise) return dbPromise;
      dbPromise = new Promise((resolve, reject) => {
        const request = indexedDB.open("calendar-hub-db", 1);
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains("calendars")) {
            db.createObjectStore("calendars", { keyPath: "id" });
          }
          if (!db.objectStoreNames.contains("events")) {
            db.createObjectStore("events", { keyPath: "id" });
          }
        };
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
      return dbPromise;
    }

    function txDone(tx) {
      return new Promise((resolve, reject) => {
        tx.oncomplete = () => resolve();
        tx.onerror = () => reject(tx.error);
        tx.onabort = () => reject(tx.error);
      });
    }

    async function saveState() {
      localStorage.setItem("calendar-hub", JSON.stringify(state));
      try {
        const db = await openDB();
        const tx = db.transaction(["calendars", "events"], "readwrite");
        const calStore = tx.objectStore("calendars");
        const evStore = tx.objectStore("events");
        calStore.clear();
        evStore.clear();
        state.calendars.forEach((c) => calStore.put(c));
        state.events.forEach((e) => evStore.put(e));
        await txDone(tx);
      } catch (e) {
        console.warn("IndexedDB: –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å", e);
      }
    }

    async function loadState() {
      let loaded = false;
      try {
        const db = await openDB();
        const tx = db.transaction(["calendars", "events"], "readonly");
        const calStore = tx.objectStore("calendars");
        const evStore = tx.objectStore("events");
        const calendars = await calStore.getAll();
        const events = await evStore.getAll();
        await txDone(tx);
        if (calendars.length || events.length) {
          state.calendars = calendars;
          state.events = events;
          loaded = true;
        }
      } catch (e) {
        console.warn("IndexedDB: –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å", e);
      }

      if (loaded) return;

      const saved = localStorage.getItem("calendar-hub");
      if (!saved) return;
      try {
        const data = JSON.parse(saved);
        state.calendars = Array.isArray(data.calendars)
          ? data.calendars.map((c) => ({ type: c.type || "local", ...c }))
          : [];
        state.events = Array.isArray(data.events)
          ? data.events.map((e) => ({ origin: e.origin || "local", ...e }))
          : [];
      } catch (e) {
        console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ", e);
      }
    }

    function formatDateTime(value) {
      const date = new Date(value);
      return date.toLocaleString("ru-RU", {
        day: "2-digit",
        month: "short",
        hour: "2-digit",
        minute: "2-digit",
      });
    }

    function renderRemoteStatus() {
      const remoteCalendars = state.calendars.filter((c) => c.type === "remote");
      if (!remoteCalendars.length) {
        remoteStatus.textContent = "–ü–æ–¥–∫–ª—é—á–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Å—Å—ã–ª–∫—É, —á—Ç–æ–±—ã –ø–æ–¥—Ç—è–Ω—É—Ç—å –≥–æ—Ç–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è.";
        remoteStatus.className = "empty";
        return;
      }
      remoteStatus.textContent = `–ü–æ–¥–∫–ª—é—á–µ–Ω–æ ${remoteCalendars.length} —Å—Å—ã–ª–æ–∫. –ù–∞–∂–º–∏—Ç–µ ‚Äú–û–±–Ω–æ–≤–∏—Ç—å –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã–µ‚Äù, —á—Ç–æ–±—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å.`;
      remoteStatus.className = "muted-note";
    }

    function renderCalendars() {
      calendarCount.textContent = state.calendars.length;
      calendarList.innerHTML = "";
      eventCalendar.innerHTML = "";

      if (!state.calendars.length) {
        calendarList.innerHTML = '<p class="empty">–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∫–∞–ª–µ–Ω–¥–∞—Ä—å, —á—Ç–æ–±—ã –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –≤—Å—Ç—Ä–µ—á–∏.</p>';
        const placeholder = document.createElement("option");
        placeholder.textContent = "–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—å";
        placeholder.disabled = true;
        placeholder.selected = true;
        eventCalendar.appendChild(placeholder);
        eventCalendar.disabled = true;
        renderRemoteStatus();
        return;
      }

      eventCalendar.disabled = false;
      state.calendars.forEach((cal) => {
        const pill = document.createElement("span");
        pill.className = "pill";
        const dot = document.createElement("span");
        dot.className = "dot";
        dot.style.background = cal.color;
        const name = document.createElement("span");
        name.textContent = cal.name;
        if (cal.type === "remote") {
          const remoteIcon = document.createElement("span");
          remoteIcon.textContent = "üåê";
          name.prepend(remoteIcon, " ");
        }
        if (cal.type === "file") {
          const fileIcon = document.createElement("span");
          fileIcon.textContent = "üìÇ";
          name.prepend(fileIcon, " ");
        }
        if (cal.lastSynced && cal.type === "remote") {
          const synced = document.createElement("span");
          synced.style.fontSize = "11px";
          synced.style.color = "var(--muted)";
          synced.textContent = new Date(cal.lastSynced).toLocaleString("ru-RU", {
            hour: "2-digit",
            minute: "2-digit",
            day: "2-digit",
            month: "short",
          });
          name.append(" ‚Ä¢ ", synced);
        }
        const count = document.createElement("span");
        count.className = "count";
        const eventCount = state.events.filter((e) => e.calendarId === cal.id).length;
        count.textContent = `${eventCount}`;
        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.title = "–£–¥–∞–ª–∏—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å";
        removeBtn.textContent = "√ó";
        removeBtn.addEventListener("click", () => handleRemoveCalendar(cal.id));
        pill.append(dot, name, count, removeBtn);
        calendarList.appendChild(pill);

        const option = document.createElement("option");
        option.value = cal.id;
        option.textContent = cal.name;
        eventCalendar.appendChild(option);
      });

      renderRemoteStatus();
    }

    async function handleRemoveCalendar(id) {
      const calendar = state.calendars.find((c) => c.id === id);
      if (!calendar) return;
      const confirmed = confirm(
        `–£–¥–∞–ª–∏—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å ¬´${calendar.name}¬ª –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –Ω–∏–º —Å–æ–±—ã—Ç–∏—è?`
      );
      if (!confirmed) return;
      state.calendars = state.calendars.filter((c) => c.id !== id);
      state.events = state.events.filter((e) => e.calendarId !== id);
      await saveState();
      renderCalendars();
      renderEvents();
      renderWeek();
    }

    function renderEvents() {
      eventsEl.innerHTML = "";
      if (!state.events.length) {
        eventsEl.innerHTML = '<p class="empty">–°–æ–±—ã—Ç–∏–π –ø–æ–∫–∞ –Ω–µ—Ç ‚Äî –¥–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ!</p>';
        return;
      }

      const sorted = [...state.events].sort(
        (a, b) => new Date(a.start).getTime() - new Date(b.start).getTime()
      );

      sorted.forEach((event) => {
        const cal = state.calendars.find((c) => c.id === event.calendarId);
        const wrapper = document.createElement("div");
        wrapper.className = "event";

        const title = document.createElement("div");
        title.innerHTML = `<strong>${event.title}</strong>`;

        const meta = document.createElement("div");
        meta.className = "meta";

        const badge = document.createElement("span");
        badge.className = "badge";
        badge.style.background = cal?.color || "#06b6d4";
        badge.textContent = cal?.name || "–ö–∞–ª–µ–Ω–¥–∞—Ä—å";

        const time = document.createElement("span");
        time.textContent = `${formatDateTime(event.start)} ‚Üí ${formatDateTime(event.end)}`;

        const location = document.createElement("span");
        location.textContent = event.location || "–û–Ω–ª–∞–π–Ω";

        const source = document.createElement("span");
        source.textContent =
          event.origin === "remote"
            ? "–ü–æ —Å—Å—ã–ª–∫–µ"
            : event.origin === "file"
            ? "–§–∞–π–ª"
            : "–õ–∏—á–Ω–æ";
        source.style.fontWeight = "600";

        meta.append(badge, time, location, source);
        wrapper.append(title, meta);
        eventsEl.appendChild(wrapper);
      });
    }

    calendarForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = calendarForm.calendarName.value.trim();
      if (!name) return;

      state.calendars.push({
        id: crypto.randomUUID(),
        name,
        color: calendarForm.calendarColor.value,
        type: "local",
      });

      calendarForm.reset();
      calendarForm.calendarColor.value = "#06b6d4";
      await saveState();
      renderCalendars();
    });

    eventForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!state.calendars.length) return;

      const payload = {
        id: crypto.randomUUID(),
        calendarId: eventCalendar.value,
        title: eventForm.eventTitle.value.trim(),
        start: eventForm.eventStart.value,
        end: eventForm.eventEnd.value,
        location: eventForm.eventLocation.value.trim(),
        origin: "local",
      };

      if (!payload.title || !payload.start || !payload.end) return;
      if (new Date(payload.end) <= new Date(payload.start)) {
        alert("–û–∫–æ–Ω—á–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–∑–∂–µ –Ω–∞—á–∞–ª–∞ —Å–æ–±—ã—Ç–∏—è.");
        return;
      }

      state.events.push(payload);
      eventForm.reset();
      await saveState();
      renderCalendars();
      renderEvents();
      renderWeek();
    });

    exportBtn.addEventListener("click", () => {
      if (!state.events.length) {
        alert("–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞.");
        return;
      }

      const ics = [
        "BEGIN:VCALENDAR",
        "VERSION:2.0",
        "PRODID:-//Calendar Hub//EN",
      ];

      state.events.forEach((event) => {
        const cal = state.calendars.find((c) => c.id === event.calendarId);
        const uid = `${event.id}@calendarhub`;
        ics.push("BEGIN:VEVENT");
        ics.push(`UID:${uid}`);
        ics.push(`SUMMARY:${event.title}`);
        ics.push(`DTSTART:${formatICSDate(event.start)}`);
        ics.push(`DTEND:${formatICSDate(event.end)}`);
        if (event.location) ics.push(`LOCATION:${event.location}`);
        if (cal) ics.push(`CATEGORIES:${cal.name}`);
        ics.push("END:VEVENT");
      });

      ics.push("END:VCALENDAR");
      const blob = new Blob([ics.join("\n")], { type: "text/calendar" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "merged-calendar.ics";
      a.click();
      URL.revokeObjectURL(url);
    });

    clearBtn.addEventListener("click", async () => {
      if (!confirm("–û—á–∏—Å—Ç–∏—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä–∏ –∏ —Å–æ–±—ã—Ç–∏—è?")) return;
      state.calendars = [];
      state.events = [];
      await saveState();
      renderCalendars();
      renderEvents();
      renderWeek();
      fileStatus.textContent = "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è offline-—Ñ–∞–π–ª—ã ICS –∏ HTML.";
      fileStatus.className = "status";
    });

    function formatICSDate(value) {
      const date = new Date(value);
      const pad = (n) => String(n).padStart(2, "0");
      return (
        date.getUTCFullYear() +
        pad(date.getUTCMonth() + 1) +
        pad(date.getUTCDate()) +
        "T" +
        pad(date.getUTCHours()) +
        pad(date.getUTCMinutes()) +
        pad(date.getUTCSeconds()) +
        "Z"
      );
    }

    function normalizeICSLines(text) {
      const rawLines = text.split(/\r?\n/);
      const lines = [];
      rawLines.forEach((line) => {
        if (line.startsWith(" ") && lines.length) {
          lines[lines.length - 1] += line.slice(1);
        } else {
          lines.push(line);
        }
      });
      return lines;
    }

    function parseICSTimestamp(value) {
      if (!value) return null;
      const match = value.match(/(\d{4})(\d{2})(\d{2})(?:T(\d{2})(\d{2})(\d{2}))?(Z)?/);
      if (!match) return null;
      const [, y, m, d, hh = "00", mm = "00", ss = "00", isUTC] = match;
      const year = Number(y);
      const month = Number(m) - 1;
      const day = Number(d);
      const hours = Number(hh);
      const minutes = Number(mm);
      const seconds = Number(ss);
      if (isUTC) {
        return new Date(Date.UTC(year, month, day, hours, minutes, seconds)).toISOString();
      }
      return new Date(year, month, day, hours, minutes, seconds).toISOString();
    }

    function extractICSFromHTML(html) {
      try {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, "text/html");
        const pre = doc.querySelector("pre");
        const text = (pre?.textContent || doc.body?.textContent || html).replace(/\u00a0/g, " ");
        const begin = text.indexOf("BEGIN:VEVENT");
        if (begin === -1) return null;
        const calStart = text.lastIndexOf("BEGIN:VCALENDAR", begin);
        const calEnd = text.indexOf("END:VCALENDAR", begin);
        if (calStart !== -1 && calEnd !== -1) {
          return text.slice(calStart, calEnd + "END:VCALENDAR".length);
        }
        return text.slice(begin);
      } catch (e) {
        console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å HTML –∫–∞–∫ –∫–∞–ª–µ–Ω–¥–∞—Ä—å", e);
        return null;
      }
    }

    function parseCalendarText(raw, filename = "") {
      const lower = raw.trim().toLowerCase();
      if (lower.includes("begin:vevent")) {
        return parseICS(raw);
      }
      if (filename.endsWith(".html") || lower.startsWith("<") || lower.includes("<html")) {
        const extracted = extractICSFromHTML(raw);
        if (extracted && extracted.toLowerCase().includes("begin:vevent")) {
          return parseICS(extracted);
        }
      }
      return [];
    }

    function parseICS(text) {
      const lines = normalizeICSLines(text);
      const events = [];
      let current = null;

      lines.forEach((line) => {
        if (line.startsWith("BEGIN:VEVENT")) {
          current = {};
          return;
        }
        if (line.startsWith("END:VEVENT")) {
          if (current?.start && current?.end) {
            events.push({
              title: current.title || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",
              start: current.start,
              end: current.end,
              location: current.location || "",
            });
          }
          current = null;
          return;
        }
        if (!current) return;

        const [rawKey, ...rawValue] = line.split(":");
        const value = rawValue.join(":");
        const key = rawKey.split(";")[0];

        if (key === "SUMMARY") current.title = value;
        if (key === "LOCATION") current.location = value;
        if (key === "DTSTART") current.start = parseICSTimestamp(value);
        if (key === "DTEND") current.end = parseICSTimestamp(value);
      });

      return events.filter((ev) => ev.start && ev.end);
    }

    async function syncRemoteCalendar(calendar, { silent = false } = {}) {
      if (!calendar?.sourceUrl) return;
      try {
        if (!silent) {
          remoteStatus.textContent = `–ó–∞–≥—Ä—É–∂–∞—é ${calendar.name}...`;
          remoteStatus.className = "muted-note";
        }
        const res = await fetch(calendar.sourceUrl, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const text = await res.text();
        const imported = parseICS(text).map((ev) => ({
          ...ev,
          id: crypto.randomUUID(),
          calendarId: calendar.id,
          origin: "remote",
        }));

        state.events = state.events.filter((e) => e.calendarId !== calendar.id || e.origin !== "remote");
        state.events.push(...imported);
        calendar.lastSynced = new Date().toISOString();
        await saveState();
        renderEvents();
        renderWeek();
        if (!silent) {
          remoteStatus.textContent = `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${calendar.name} (${imported.length} —Å–æ–±—ã—Ç–∏–π).`;
          remoteStatus.className = "muted-note";
        }
      } catch (err) {
        console.error(err);
        if (!silent) {
          remoteStatus.textContent = `–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å ${calendar.name}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Å—ã–ª–∫—É –∏–ª–∏ CORS.`;
          remoteStatus.className = "empty";
        }
      }
    }

    async function refreshAllRemoteCalendars({ announce = true } = {}) {
      const remoteCalendars = state.calendars.filter((c) => c.type === "remote");
      if (!remoteCalendars.length) {
        if (announce) {
          remoteStatus.textContent = "–ù–µ—Ç –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã—Ö —Å—Å—ã–ª–æ–∫.";
          remoteStatus.className = "empty";
        }
        return;
      }

      if (announce) {
        remoteStatus.textContent = "–û–±–Ω–æ–≤–ª—è—é –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã–µ –∫–∞–ª–µ–Ω–¥–∞—Ä–∏...";
        remoteStatus.className = "muted-note";
      }

      for (const cal of remoteCalendars) {
        await syncRemoteCalendar(cal, { silent: !announce });
      }

      if (announce) {
        const refreshed = remoteCalendars.filter((c) => c.lastSynced).length;
        remoteStatus.textContent = `–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ: ${refreshed}/${remoteCalendars.length}.`;
        remoteStatus.className = "muted-note";
      }
      renderCalendars();
    }

    async function importFileCalendar(file) {
      if (!file) {
        fileStatus.textContent = "–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª .ics –∏–ª–∏ .html.";
        fileStatus.className = "status empty";
        return;
      }

      fileStatus.textContent = `–ß–∏—Ç–∞—é ${file.name}...`;
      fileStatus.className = "status muted-note";
      try {
        const text = await file.text();
        const imported = parseCalendarText(text, file.name);
        if (!imported.length) {
          fileStatus.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Å–æ–±—ã—Ç–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞.";
          fileStatus.className = "status empty";
          return;
        }

        const calendar = {
          id: crypto.randomUUID(),
          name: fileCalendarName.value.trim() || file.name || "–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å",
          color: fileCalendarColor.value,
          type: "file",
        };

        const mapped = imported.map((ev) => ({
          ...ev,
          id: crypto.randomUUID(),
          calendarId: calendar.id,
          origin: "file",
        }));

        state.calendars.push(calendar);
        state.events.push(...mapped);
        await saveState();
        renderCalendars();
        renderEvents();
        renderWeek();
        fileForm.reset();
        fileCalendarColor.value = "#a855f7";
        fileStatus.textContent = `–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${mapped.length} —Å–æ–±—ã—Ç–∏–π –∏–∑ ${file.name}.`;
        fileStatus.className = "status muted-note";
      } catch (e) {
        console.error(e);
        fileStatus.textContent = "–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.";
        fileStatus.className = "status empty";
      }
    }

    function renderWeek() {
      weekView.innerHTML = "";
      const now = new Date();
      const day = now.getDay();
      const mondayOffset = (day + 6) % 7;
      const monday = new Date(now);
      monday.setDate(now.getDate() - mondayOffset);
      monday.setHours(0, 0, 0, 0);
      const sunday = new Date(monday);
      sunday.setDate(monday.getDate() + 7);

      const weekEvents = state.events.filter((ev) => {
        const start = new Date(ev.start);
        return start >= monday && start < sunday;
      });

      for (let i = 0; i < 7; i++) {
        const dayDate = new Date(monday);
        dayDate.setDate(monday.getDate() + i);
        const weekdayLabel = dayDate
          .toLocaleDateString("ru-RU", { weekday: "short" })
          .replace(".", "");
        const dateLabel = dayDate
          .toLocaleDateString("ru-RU", { day: "2-digit", month: "short" })
          .replace(".", "");

        const column = document.createElement("div");
        column.className = "day";
        const heading = document.createElement("h3");
        const title = document.createElement("span");
        title.textContent = `${weekdayLabel.toUpperCase()} ‚Ä¢ ${dateLabel}`;
        heading.appendChild(title);
        column.appendChild(heading);

        const dayEvents = weekEvents
          .filter((ev) => new Date(ev.start).toDateString() === dayDate.toDateString())
          .sort((a, b) => new Date(a.start) - new Date(b.start));

        const counter = document.createElement("span");
        counter.className = "count";
        counter.textContent = dayEvents.length ? `${dayEvents.length}` : "0";
        heading.appendChild(counter);

        if (!dayEvents.length) {
          const empty = document.createElement("p");
          empty.className = "muted-note";
          empty.textContent = "–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π";
          column.appendChild(empty);
        } else {
          dayEvents.forEach((ev) => {
            const cal = state.calendars.find((c) => c.id === ev.calendarId);
            const item = document.createElement("div");
            item.className = "event-item";
            const title = document.createElement("div");
            title.innerHTML = `<strong>${ev.title}</strong>`;
            const meta = document.createElement("div");
            meta.className = "meta";
            const badge = document.createElement("span");
            badge.className = "badge";
            badge.style.background = cal?.color || "#06b6d4";
            badge.textContent = cal?.name || "–ö–∞–ª–µ–Ω–¥–∞—Ä—å";
            const time = document.createElement("span");
            time.textContent = `${formatDateTime(ev.start)} ‚Üí ${formatDateTime(ev.end)}`;
            meta.append(badge, time);
            item.append(title, meta);
            column.appendChild(item);
          });
        }

        weekView.appendChild(column);
      }
    }

    remoteForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const url = remoteForm.remoteUrl.value.trim();
      if (!url) return;
      const name = remoteForm.remoteName.value.trim() || new URL(url).hostname;
      const calendar = {
        id: crypto.randomUUID(),
        name,
        color: remoteForm.remoteColor.value,
        sourceUrl: url,
        type: "remote",
      };
      state.calendars.push(calendar);
      await saveState();
      renderCalendars();
      renderEvents();
      renderWeek();
      remoteForm.reset();
      remoteForm.remoteColor.value = "#22c55e";
      await syncRemoteCalendar(calendar);
    });

    refreshRemote.addEventListener("click", async () => {
      await refreshAllRemoteCalendars();
    });

    fileForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const file = fileInput.files?.[0];
      await importFileCalendar(file);
    });

    async function init() {
      await loadState();
      renderCalendars();
      renderEvents();
      renderWeek();
      refreshAllRemoteCalendars({ announce: false });

      setInterval(() => {
        refreshAllRemoteCalendars({ announce: false });
      }, AUTO_REFRESH_MS);
    }

    init();
  </script>
</body>
</html>
